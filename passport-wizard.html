<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ÙØ±Ù… Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ Ú¯Ø°Ø±Ù†Ø§Ù…Ù‡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

 <style>
@font-face{
  font-family: "Vazirmatn";
  src: url("assets/fonts/vazirmatn/Vazirmatn-Regular.woff2") format("woff2");
  font-weight: 400;
  font-style: normal;
  font-display: swap;
}
body{
  font-family: "Vazirmatn", sans-serif;
  margin: 0;
  padding: 16px;
  padding-left: max(16px, env(safe-area-inset-left));
  padding-right: max(16px, env(safe-area-inset-right));
  background: linear-gradient(to bottom, #eef2f8 0%, #f6f8fc 60%);
  color: #0f172a;
  overflow-x: hidden;
}

.flow-wrap{
  max-width: 560px;
  margin: 0 auto;
}

/* Header (minimal, aligned) */
.flow-top{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 10px 6px 6px;
}

.flow-service{
  font-size: 12px;
  color: rgba(15, 23, 42, .45);
  letter-spacing: .2px;
}

.back-link{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  color: #0f172a;
  font-size: 13px;
  font-weight: 500;
  padding: 8px 12px;
  border-radius: 999px;
  background: rgba(15, 23, 42, 0.05);
  border: 1px solid rgba(15, 23, 42, 0.08);
}
.back-link:hover{
  background: rgba(15, 23, 42, 0.07);
}
/* Head text */
.flow-head{
  margin: 18px 6px 14px;
}
.flow-kicker{
  font-size: 12px;
  color: rgba(15, 23, 42, .55);
  margin-bottom: 6px;
}
.flow-title{
  margin: 0 0 6px 0;
  font-size: 18px;
  line-height: 1.7;
  font-weight: 700;
  color: #0f172a;
}
.flow-subtitle{
  font-size: 13px;
  line-height: 1.8;
  color: rgba(15, 23, 42, .65);
}

/* Main card */
.card{
  background: #ffffff;
  border-radius: 20px;
  box-shadow: 0 20px 40px rgba(2, 8, 23, .06);
  border: 1px solid rgba(2, 8, 23, .07);
  padding: 22px;
  margin: 14px 0 0;
}

/* Progress */
.progress{
  font-size: 12px;
  color: rgba(15, 23, 42, .50);
  margin-bottom: 6px;
  text-align: right;
}

/* Question */
h3{
  margin: 0 0 14px 0;
  font-size: 20px;
  line-height: 1.9;
  font-weight: 700;
}

/* Input */
input{
  width: 100%;
  padding: 14px 14px;
  font-size: 16px; /* Ù…Ù‡Ù…: iOS zoom Ù†Ø´ÙˆØ¯ */
  border-radius: 14px;
  border: 1px solid #e5eaf3;
  background: #f8fafc;
  outline: none;

  text-align: right;
  direction: rtl;
  box-sizing: border-box;
}
  
.ios-hint {
  font-size: 12px;
  color: #888;
  margin-top: 10px;
} 

.hero-input:focus {
  border-color: #4caf50;  /* Ø³Ø¨Ø² Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª ÙØ¹Ø§Ù„ */
  box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);  /* Ø³Ø§ÛŒÙ‡ Ø³Ø¨Ø² Ø±ÙˆØ´Ù† Ø¨Ø±Ø§ÛŒ Ú†Ø´Ù…Ú©â€ŒØ²Ù† */
}

/* Buttons */
button{
  width: 100%;
  padding: 14px;
  font-size: 16px;
  border-radius: 14px;
  border: none;
  cursor: pointer;
  margin-top: 10px;
  min-height: 52px; /* Thumb-friendly */
}

.primary{
  color: #fff;
  background: linear-gradient(to bottom, #17335f, #0f2547);
  box-shadow: 0 10px 20px rgba(15, 37, 71, .25);
}

.voice{
  background: rgba(15, 23, 42, 0.06);
  color: #0f172a;
  border: 1px solid rgba(15, 23, 42, 0.10);
}

/* iOS hint */
.ios-hint{
  display:none;
  margin-top: 10px;
  font-size: 13px;
  color: rgba(15, 23, 42, .60);
  line-height: 1.8;
}

/* Bottom links */
.bottom-row{
  margin-top: 14px;
  display: flex;
  justify-content: space-between;
  gap: 10px;
  font-size: 13px;
  color: rgba(15, 23, 42, .60);
}
.bottom-row a{
  text-decoration: none;
  color: rgba(15, 37, 71, .95);
  opacity: .9;
}

/* Success state polish */
.success-note{
  margin-top: 10px;
  font-size: 13px;
  color: rgba(15, 23, 42, .60);
}
@keyframes blink {
  0% { opacity: 1; }
  50% { opacity: .35; }
  100% { opacity: 1; }
}
/* Mobile */
@media (max-width: 480px){
  body{ padding: 14px; }
  .flow-title{ font-size: 19px; }
  .card{ padding: 20px; }
}
  @media (min-width: 900px){
  .flow-head{ margin-top: 8px; }
  .card{ margin-top: 12px; }
} 
   /* ===== Service-like top bar ===== */
.flow-top--service{
  padding: 14px 6px 6px;
}
/* [ANCHOR:C1 TOPBAR-ALIGN] */
.flow-top--service{
  direction: ltr; /* ØªØ±ØªÛŒØ¨ Ø¨ØµØ±ÛŒ Ø±Ø§ Ú†Ù¾â†’Ø±Ø§Ø³Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯ */
}
.flow-top--service *{
  direction: rtl; /* Ù…ØªÙ†â€ŒÙ‡Ø§ Ù‡Ù…Ú†Ù†Ø§Ù† RTL Ø¨Ù…Ø§Ù†Ù†Ø¯ */
}

.brand{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  text-decoration:none;
  border-radius: 18px;
  padding: 10px 12px;
  background: rgba(255,255,255,.65);
  border: 1px solid rgba(2,8,23,.08);
  box-shadow: 0 10px 24px rgba(2,8,23,.06);
}

.brand__logo{
  width: 104px;
  height: auto;
  display:block;
  /* Ø§Ú¯Ø± Ù„ÙˆÚ¯Ùˆ ØªÛŒØ±Ù‡ Ù†ÛŒØ³Øª Ùˆ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒ Ø³Ø±Ù…Ù‡â€ŒØ§ÛŒ Ø´ÙˆØ¯ Ùˆ SVG Ø§Ø³ØªØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ø¨Ø¹Ø¯Ø§Ù‹ fill Ø±Ø§ Ø³Øª Ú©Ù†ÛŒ */
}

.cta-service{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  text-decoration:none;
  padding: 12px 18px;
  border-radius: 999px;
  font-size: 14px;
  font-weight: 700;
  color:#fff;
  background: linear-gradient(to bottom, #17335f, #0f2547);
  box-shadow: 0 10px 20px rgba(15, 37, 71, .22);
}
   .cta-service.is-disabled{
  opacity: .45;
  pointer-events: none;
  filter: grayscale(.2);
}

/* ===== Head becomes the main hero (question+input) ===== */
.flow-head--compact{
  margin: 20px 6px 10px;
}

.hero-question{
  font-size: 28px;
  line-height: 1.5;
  font-weight: 800;
  text-align: center;
  color: rgba(15,23,42,.65);
  margin: 28px 0 14px;
}

.hero-row{
  display:flex;
  align-items:center;
  gap: 12px;
  justify-content:center;
}

.hero-back{
  width: 88px;
  height: 72px;
  border-radius: 18px;
  border: 1px solid rgba(2,8,23,.10);
  background: #1f6b4a; /* Ø³Ø¨Ø² Ù…Ø«Ù„ Ù†Ù…ÙˆÙ†Ù‡â€ŒØ§Øª */
  color:#fff;
  font-size: 22px;
  cursor:pointer;
  box-shadow: 0 14px 30px rgba(2,8,23,.10);
}
  /* [ANCHOR:B1 HERO-NEXT] */
.hero-next{
  width: 88px;
  height: 72px;
  border-radius: 18px;
  border: 1px solid rgba(2,8,23,.10);
  background: #1f6b4a; /* Ù‡Ù…Ø§Ù† Ø³Ø¨Ø² Ù†Ù…ÙˆÙ†Ù‡ */
  color:#fff;
  font-size: 22px;
  cursor:pointer;
  box-shadow: 0 14px 30px rgba(2,8,23,.10);
}

.hero-next:disabled{
  opacity: .35;
  cursor: not-allowed;
  box-shadow: none;
} 

.hero-input{
  width: min(520px, 100%);
  height: 72px;
  border-radius: 22px;
  border: 1px solid rgba(2,8,23,.10);
  background: rgba(255,255,255,.85);
  box-shadow: 0 14px 30px rgba(2,8,23,.08);
  padding: 0 22px;
  font-size: 22px;
  font-weight: 700;
  text-align: right;
  direction: rtl;
}
/* [ANCHOR:B1 HERO-BUTTONS-ATTACH] */
.hero-row{
  gap: 0;                 /* Ø¨Ú†Ø³Ø¨Ù†Ø¯ */
}

.hero-btn{
  width: 88px;
  height: 72px;
  border-radius: 18px;
  border: 1px solid rgba(2,8,23,.10);
  background: #1f6b4a;
  color: #fff;
  font-size: 22px;
  cursor: pointer;
    margin-top: 0;
  box-shadow: 0 14px 30px rgba(2,8,23,.10);

  display: inline-flex;
  align-items: center;
  justify-content: center;

  transition: opacity .18s ease, transform .18s ease, filter .18s ease;
}

.hero-btn:disabled{
  opacity: .28;
  cursor: not-allowed;
  box-shadow: none;
  filter: grayscale(.2);
}

/* Ø§ØªØµØ§Ù„ Ø¨Ù‡ input (Ù„Ø¨Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ Ù…Ø±Ø¨Ø¹â€ŒØªØ± Ø´ÙˆÙ†Ø¯) */
.hero-prev{ border-top-left-radius: 0; border-bottom-left-radius: 0; }
.hero-next{ border-top-right-radius: 0; border-bottom-right-radius: 0; }

.hero-input{
  border-radius: 0;        /* ÙˆØ³Ø· ØªØ®Øª Ø´ÙˆØ¯ */
  border-left: 0;
  border-right: 0;
}
  /* [ANCHOR:B2 PLACEHOLDER] */
.hero-input::placeholder{
  color: rgba(15,23,42,.65);  /* Ø®ÛŒÙ„ÛŒ Ú©Ù…Ø±Ù†Ú¯ */
  font-weight: 800;
  animation: blink 1s infinite;
}
.hero-input:focus{
  outline:none;
  border-color: rgba(28,61,117,.45);
  box-shadow: 0 0 0 3px rgba(28,61,117,.08), 0 14px 30px rgba(2,8,23,.08);
}
  .dots {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin: 14px 0 10px;
}

.dot {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: #e0e0e0; /* Ø±Ù†Ú¯ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø®Ø§Ú©ÛŒ */
}

.dot.is-active {
  background: #4caf50; /* Ø³Ø¨Ø² Ø±Ù†Ú¯ Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„ */
}

.dot.is-done {
  background: #388e3c; /* Ø³Ø¨Ø² ØªÛŒØ±Ù‡ Ø¨Ø±Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡ */
} 

.dots{
  display:flex;
  justify-content:center;
  gap: 8px;
  margin: 14px 0 10px;
  flex-wrap: wrap;
}

.dot{
  width: 14px;
  height: 14px;
  border-radius: 999px;
  background: rgba(2,8,23,.10);
  border: 1px solid rgba(2,8,23,.10);
  box-shadow: inset 0 1px 1px rgba(255,255,255,.7);
}
.dot.is-active{
  background: rgba(2,8,23,.22);
}
.dot.is-done{
  background: rgba(31,107,74,.28);
  border-color: rgba(31,107,74,.25);
}

.helper{
  text-align:center;
  font-size: 15px;
  line-height: 1.9;
  color: rgba(15,23,42,.55);
  margin-top: 8px;
}
  /* Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªÛŒÚ© Ø³Ø¨Ø² */
.checkmark {
  color: #388e3c; /* Ø±Ù†Ú¯ Ø³Ø¨Ø² ØªÛŒÚ© */
  font-size: 24px;  /* Ø³Ø§ÛŒØ² ØªÛŒÚ© */
  margin-left: 10px;  /* ÙØ§ØµÙ„Ù‡ Ø§Ø² Ù…ØªÙ† */
} 

/* Actions card becomes minimal (just buttons) */
.card--actions{
  margin-top: 18px;
  max-width: 560px;
}

/* Mobile tweaks */
@media (max-width: 480px){
  .hero-question{ font-size: 22px; margin-top: 18px; }
  .hero-back{ width: 72px; height: 62px; }
  .hero-input{ height: 62px; font-size: 18px; border-radius: 18px; }
  /* [ANCHOR:B3 MOBILE HERO BUTTONS] */
.hero-next{ width: 72px; height: 62px; }
  .dot{ width: 12px; height: 12px; }
}
  /* [ANCHOR:B3 MOBILE HERO BUTTONS] */
@media (max-width: 480px){
  .hero-btn{ width: 72px; height: 62px; }
}
  
.hero-input::placeholder {
  animation: blink 1s infinite; /* Ø§ÙØ²ÙˆØ¯Ù† Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ú†Ø´Ù…Ú© Ø²Ø¯Ù† */
  color: rgba(15, 23, 42, 0.65); /* Ø±Ù†Ú¯ placeholder */
}
</style>
</head>
<body>

<div class="flow-wrap">

<div class="flow-top flow-top--service">
  <!-- Ù„ÙˆÚ¯ÙˆÛŒ Ø¯ÙØªØ± (Ù‡Ù…Ø§Ù† ÙØ§ÛŒÙ„ Ø±ÛŒÙ¾Ùˆ) -->
  <a class="brand" href="index.html" aria-label="Ù¾Ù„ÛŒØ³+Û±Û° Ø§ÙØ³Ø±ÛŒÙ‡">
    <img src="assets/img/logo/logo_white.png" class="brand__logo" alt="Ù¾Ù„ÛŒØ³+Û±Û° Ø§ÙØ³Ø±ÛŒÙ‡">
  </a>

  <!-- Ø¯Ú©Ù…Ù‡ Ø¯Ø±ÛŒØ§ÙØª ÙØ±Ù… Ú¯Ø°Ø±Ù†Ø§Ù…Ù‡ (Ù‡Ù…Ø§Ù† Ø§Ø³ØªØ§ÛŒÙ„/Ú©Ø§Ù†Ù¾ÙˆÙ†Ù†Øª ØµÙØ­Ù‡ Ø®Ø¯Ù…Øª) -->
  <a class="cta-service is-disabled" id="topDownloadLink" href="assets/forms/passport.pdf" download aria-disabled="true" tabindex="-1">
    Ø¯Ø±ÛŒØ§ÙØª ÙØ±Ù… Ú¯Ø°Ø±Ù†Ø§Ù…Ù‡
  </a>
</div>

 <div class="flow-head flow-head--compact">
  <div class="hero-question" id="heroQuestion">Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯</div>

<!-- [ANCHOR:A1 HERO-ROW] -->
<div class="hero-row">
  <!-- Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„ (Ø³Ù…Øª Ø±Ø§Ø³ØªÙ ØµÙØ­Ù‡ RTL) -->
  <button class="hero-btn hero-prev" id="prevButton" type="button" aria-label="Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„">â–¶</button>

  <!-- ÙˆØ±ÙˆØ¯ÛŒ -->
  <input
    class="hero-input"
    type="text"
    id="answerInput"
    inputmode="text"
    autocomplete="off"
    autocorrect="on"
    autocapitalize="none"
    spellcheck="true"
    placeholder=""
  />

  <!-- Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ (Ø³Ù…Øª Ú†Ù¾Ù ØµÙØ­Ù‡ RTL) -->
  <button class="hero-btn hero-next" id="nextButton" type="button" aria-label="Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯">â—€</button>
</div>

  <div class="dots" id="dots"></div>

  <div class="helper" id="helperText">
    Ù¾Ø³ Ø§Ø² ØªÚ©Ù…ÛŒÙ„ Ù…Ø±Ø§Ø­Ù„ØŒ Ø¯Ú©Ù…Ù‡ Â«Ø¯Ø±ÛŒØ§ÙØª ÙØ±Ù… Ú¯Ø°Ø±Ù†Ø§Ù…Ù‡Â» ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
  </div>
</div>

 <div class="card card--actions">

  <div class="ios-hint" id="iosHint">
    Ø¯Ø± Ø¢ÛŒÙÙˆÙ†ØŒ Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ ØµÙˆØªÛŒ Ø§Ø² Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ†Ù Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.
  </div>

  <button class="voice" id="voiceButton" type="button">ğŸ¤ ÙˆØ±ÙˆØ¯ ØµÙˆØªÛŒ</button>

  <button class="primary" id="downloadPdfButton" type="button" style="display:none;">Ø¯Ø±ÛŒØ§ÙØª ÙØ±Ù… Ú¯Ø°Ø±Ù†Ø§Ù…Ù‡</button>

  <div class="bottom-row">
    <a href="passport.html">Ø®Ø±ÙˆØ¬</a>
    <a href="#" onclick="location.reload(); return false;">Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯</a>
  </div>

  <div class="success-note" id="wmNote" style="display:none;">
    ÙØ§ÛŒÙ„ Ø®Ø±ÙˆØ¬ÛŒ Ø´Ø§Ù…Ù„ ÙˆØ§ØªØ±Ù…Ø§Ø±Ú© Ø¯ÙØªØ± Ø§Ø³Øª.
  </div>
</div>

</div>
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = {
    sections: [
      {
        title: "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡ÙˆÛŒØªÛŒ",
        fields: [
          { question: "Ù†Ø§Ù… Ø´Ù…Ø§ Ú†ÛŒØ³ØªØŸ", key: "firstName" },
          { question: "Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø´Ù…Ø§ Ú†ÛŒØ³ØªØŸ", key: "lastName" }
        ]
      },
      {
        title: "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¸Ø§Ù‡Ø±ÛŒ",
        fields: [
          { question: "Ù‚Ø¯ Ø´Ù…Ø§ Ú†Ù‚Ø¯Ø± Ø§Ø³ØªØŸ", key: "height" }
        ]
      }
    ]
  };

  const inputEl = document.getElementById("answerInput");
  const heroQuestionEl = document.getElementById("heroQuestion");
 const nextBtn = document.getElementById("nextButton");
const prevBtn = document.getElementById("prevButton");
const dotsEl = document.getElementById("dots");
 const topDownloadLink = document.getElementById("topDownloadLink"); 

const voiceBtn = document.getElementById("voiceButton");
const downloadBtn = document.getElementById("downloadPdfButton");
const iosHint = document.getElementById("iosHint");

// iOS: voice hidden + hint
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
if (isIOS) {
  voiceBtn.style.display = "none";
  iosHint.style.display = "block";
}

function updateNavState() {
  prevBtn.disabled = (currentStep === 0);
  nextBtn.disabled = (inputEl.value.trim() === "");
}

  function normalizePersianNumbers(text) {
    return String(text || "")
      .replace(/[Û°-Û¹]/g, d => "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹".indexOf(d))
      .replace(/[Ù -Ù©]/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d));
  }

  const totalSteps = form.sections.reduce((sum, s) => sum + (s.fields?.length || 0), 0);

  let currentStep = 0;
   const answers = {};

  function resolveStep(step) {
    let sectionIndex = 0;
    let fieldIndex = step;

    while (sectionIndex < form.sections.length && fieldIndex >= form.sections[sectionIndex].fields.length) {
      fieldIndex -= form.sections[sectionIndex].fields.length;
      sectionIndex++;
    }

    const section = form.sections[sectionIndex];
    const field = section.fields[fieldIndex];
    return { sectionIndex, fieldIndex, field };
  }

  function renderDots() {
    dotsEl.innerHTML = "";
    for (let i = 0; i < totalSteps; i++) {
      const d = document.createElement("span");
      d.className =
        "dot" +
        (i < currentStep ? " is-done" : "") +
        (i === currentStep ? " is-active" : "");
      dotsEl.appendChild(d);
    }
  }

function showQuestion() {
  if (currentStep < totalSteps) {
    const { field } = resolveStep(currentStep);

    const qText = field.question;

    // Ø³ÙˆØ§Ù„ Ø¯Ø§Ø®Ù„ placeholder
    heroQuestionEl.style.display = "none";
    inputEl.style.display = "block";

    // Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ù†Ø±Ù…
    inputEl.style.transition = "opacity 0.22s ease, transform 0.22s ease";
    inputEl.style.opacity = "0";
    inputEl.style.transform = "translateY(6px)";

    window.requestAnimationFrame(() => {
      inputEl.placeholder = `${qText}`;
      inputEl.value = answers[field.key] || "";

      // Ù†ÙˆØ¹ ÙˆØ±ÙˆØ¯ÛŒ
      if (field.key === "height") {
        inputEl.type = "text";
        inputEl.inputMode = "decimal";
        inputEl.dir = "ltr";
      } else {
        inputEl.type = "text";
        inputEl.inputMode = "text";
        inputEl.dir = "rtl";
      }

      // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ù‡Ù…ÛŒØ´Ù‡ visible
      prevBtn.style.display = "inline-flex";
      nextBtn.style.display = "inline-flex";
topDownloadLink.classList.remove("is-disabled");
topDownloadLink.removeAttribute("aria-disabled");
topDownloadLink.removeAttribute("tabindex");
      // Ù¾Ø§ÛŒØ§Ù†/Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…Ø®ÙÛŒ
      downloadBtn.style.display = "none";
      document.getElementById("wmNote").style.display = "none";

      renderDots();
      updateNavState();

      // fade in
      window.requestAnimationFrame(() => {
        inputEl.style.opacity = "1";
        inputEl.style.transform = "translateY(0)";
      });

      inputEl.focus();  // Ø§ÛŒÙ† Ø®Ø· ÙˆØ±ÙˆØ¯ÛŒ Ø±Ø§ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ ØªØ§ Ù…Ø³ØªØ·ÛŒÙ„ Ú†Ø´Ù…Ú© Ø¨Ø²Ù†Ø¯
    });

    return;
  }

  // Ù¾Ø§ÛŒØ§Ù†
 heroQuestionEl.style.display = "block";

/* Ù…ØªÙ† Ù¾Ø§ÛŒØ§Ù† Ø±Ø§ Ø¨Ø§ HTML Ú©Ù†ØªØ±Ù„â€ŒØ´Ø¯Ù‡ Ø¨Ú¯Ø°Ø§Ø± ØªØ§ Ù‡Ù… Ù…ØªÙ† Ø¨Ø§Ø´Ø¯ Ù‡Ù… ØªÛŒÚ© */
heroQuestionEl.innerHTML = `ØªÙ…Ø§Ù… Ø´Ø¯ <span class="checkmark">âœ”</span>`;

  inputEl.style.display = "none";
  prevBtn.style.display = "none";
  nextBtn.style.display = "none";
  voiceBtn.style.display = "none";

  downloadBtn.style.display = "inline-flex";
  document.getElementById("wmNote").style.display = "block";

  renderDots();
}
   
  inputEl.addEventListener("input", updateNavState);

  // Enter ÙÙ‚Ø· next
  inputEl.addEventListener("keydown", function(e){
    if (e.key === "Enter") {
      e.preventDefault();
      nextBtn.click();
    }
  });

  nextBtn.addEventListener("click", function () {
    const raw = inputEl.value.trim();
    if (!raw) return;

    const { field } = resolveStep(currentStep);
    answers[field.key] = normalizePersianNumbers(raw);

    currentStep++;
    showQuestion();
  });

  prevBtn.addEventListener("click", function () {
    if (currentStep <= 0) return;

    // Ø°Ø®ÛŒØ±Ù‡ Ù…Ù‚Ø¯Ø§Ø± Ù…Ø±Ø­Ù„Ù‡ ÙØ¹Ù„ÛŒ Ù‡Ù… Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯
    const { field } = resolveStep(currentStep);
    const raw = inputEl.value.trim();
    if (raw) answers[field.key] = normalizePersianNumbers(raw);

    currentStep--;
    showQuestion();
  });

  // Voice Input (Android/Windows)
  voiceBtn.addEventListener("click", function () {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("Ø§ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø² ÙˆØ±ÙˆØ¯ÛŒ ØµÙˆØªÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.");
      return;
    }

    const recognition = new SpeechRecognition();
    recognition.lang = "fa-IR";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    voiceBtn.disabled = true;
    voiceBtn.textContent = "ğŸ™ï¸ Ø¯Ø± Ø­Ø§Ù„ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù†...";

    recognition.onresult = function (event) {
      const text = event.results?.[0]?.[0]?.transcript || "";
      inputEl.value = normalizePersianNumbers(text);
      updateNavState();
    };

    recognition.onerror = function (event) {
      alert("Ø®Ø·Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ ØµÙˆØªÛŒ: " + (event.error || "Ù†Ø§Ù…Ø´Ø®Øµ"));
    };

    recognition.onend = function () {
      voiceBtn.disabled = false;
      voiceBtn.textContent = "ğŸ¤ ÙˆØ±ÙˆØ¯ ØµÙˆØªÛŒ";
    };

    recognition.start();
  });

  // ====== PNG TEXT RENDER ======
  async function drawTextAsPngOnPdf(pdfDoc, page, text, x, y, fontSize) {
    const t = String(text ?? "").trim();
    if (!t) return;

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    const pad = Math.ceil(fontSize * 0.6);

    ctx.font = `${fontSize}px Vazirmatn`;
    ctx.direction = "rtl";
    ctx.textAlign = "right";
    ctx.textBaseline = "alphabetic";

    const m = ctx.measureText(t);
    const w = Math.ceil(m.width) + pad * 2;
    const h = Math.ceil(fontSize * 1.6) + pad * 2;

    canvas.width = w;
    canvas.height = h;

    ctx.font = `${fontSize}px Vazirmatn`;
    ctx.direction = "rtl";
    ctx.textAlign = "right";
    ctx.textBaseline = "alphabetic";

    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = "#000";
    ctx.fillText(t, w - pad, h - pad);

    const dataUrl = canvas.toDataURL("image/png");
    const pngBytes = await fetch(dataUrl).then(r => r.arrayBuffer());
    const png = await pdfDoc.embedPng(pngBytes);

    const SCALE = 0.75;
    const imgW = w * SCALE;
    const imgH = h * SCALE;

    page.drawImage(png, {
      x: x - imgW + 1,
      y: y - (fontSize * SCALE),
      width: imgW,
      height: imgH,
    });
  }
  // ====== END PNG TEXT RENDER ======

  async function generatePdf(answers) {
    const { PDFDocument } = PDFLib;

    const templateUrl = "assets/forms/passport.pdf";
    const existingPdfBytes = await fetch(templateUrl).then(r => r.arrayBuffer());
    const pdfDoc = await PDFDocument.load(existingPdfBytes);
    const page0 = pdfDoc.getPages()[0];

    await drawTextAsPngOnPdf(pdfDoc, page0, answers.firstName, 451.25, 652.5, 11);
    await drawTextAsPngOnPdf(pdfDoc, page0, answers.lastName,  372.5,  615.63, 11);
    await drawTextAsPngOnPdf(pdfDoc, page0, answers.height,    326.88, 513.13, 11);

    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "passport-filled.pdf";
    a.click();
    URL.revokeObjectURL(url);
  }

  downloadBtn.addEventListener("click", async function () {
    try {
      await generatePdf(answers);
    } catch (e) {
      console.error(e);
      alert("Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª PDF");
    }
  });

  showQuestion();
});
</script>

</body>
</html>
