<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ÙØ±Ù… Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ Ú¯Ø°Ø±Ù†Ø§Ù…Ù‡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

 <style>
@font-face{
  font-family: "Vazirmatn";
  src: url("assets/fonts/vazirmatn/Vazirmatn-Regular.woff2") format("woff2");
  font-weight: 400;
  font-style: normal;
  font-display: swap;
}
body{
  font-family: "Vazirmatn", sans-serif;
  margin: 0;
  padding: 16px;
  padding-left: max(16px, env(safe-area-inset-left));
  padding-right: max(16px, env(safe-area-inset-right));
  background: linear-gradient(to bottom, #eef2f8 0%, #f6f8fc 60%);
  color: #0f172a;
  overflow-x: hidden;
}

.flow-wrap{
  max-width: 560px;
  margin: 0 auto;
}

/* Header (minimal, aligned) */
.flow-top{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 10px 6px 6px;
}

.flow-service{
  font-size: 12px;
  color: rgba(15, 23, 42, .45);
  letter-spacing: .2px;
}

.back-link{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  color: #0f172a;
  font-size: 13px;
  font-weight: 500;
  padding: 8px 12px;
  border-radius: 999px;
  background: rgba(15, 23, 42, 0.05);
  border: 1px solid rgba(15, 23, 42, 0.08);
}
.back-link:hover{
  background: rgba(15, 23, 42, 0.07);
}
/* Head text */
.flow-head{
  margin: 18px 6px 14px;
}
.flow-kicker{
  font-size: 12px;
  color: rgba(15, 23, 42, .55);
  margin-bottom: 6px;
}
.flow-title{
  margin: 0 0 6px 0;
  font-size: 18px;
  line-height: 1.7;
  font-weight: 700;
  color: #0f172a;
}
.flow-subtitle{
  font-size: 13px;
  line-height: 1.8;
  color: rgba(15, 23, 42, .65);
}

/* Main card */
.card{
  background: #ffffff;
  border-radius: 20px;
  box-shadow: 0 20px 40px rgba(2, 8, 23, .06);
  border: 1px solid rgba(2, 8, 23, .07);
  padding: 22px;
  margin: 14px 0 0;
}

/* Progress */
.progress{
  font-size: 12px;
  color: rgba(15, 23, 42, .50);
  margin-bottom: 6px;
  text-align: right;
}

/* Question */
h3{
  margin: 0 0 14px 0;
  font-size: 20px;
  line-height: 1.9;
  font-weight: 700;
}

/* Input */
input{
  width: 100%;
  padding: 14px 14px;
  font-size: 16px; /* Ù…Ù‡Ù…: iOS zoom Ù†Ø´ÙˆØ¯ */
  border-radius: 14px;
  border: 1px solid #e5eaf3;
  background: #f8fafc;
  outline: none;

  text-align: right;
  direction: rtl;
  box-sizing: border-box;
}

input:focus{
  border-color: rgba(28, 61, 117, .55);
  box-shadow: 0 0 0 3px rgba(28, 61, 117, .08);
}

/* Buttons */
button{
  width: 100%;
  padding: 14px;
  font-size: 16px;
  border-radius: 14px;
  border: none;
  cursor: pointer;
  margin-top: 10px;
  min-height: 52px; /* Thumb-friendly */
}

.primary{
  color: #fff;
  background: linear-gradient(to bottom, #17335f, #0f2547);
  box-shadow: 0 10px 20px rgba(15, 37, 71, .25);
}

.voice{
  background: rgba(15, 23, 42, 0.06);
  color: #0f172a;
  border: 1px solid rgba(15, 23, 42, 0.10);
}

/* iOS hint */
.ios-hint{
  display:none;
  margin-top: 10px;
  font-size: 13px;
  color: rgba(15, 23, 42, .60);
  line-height: 1.8;
}

/* Bottom links */
.bottom-row{
  margin-top: 14px;
  display: flex;
  justify-content: space-between;
  gap: 10px;
  font-size: 13px;
  color: rgba(15, 23, 42, .60);
}
.bottom-row a{
  text-decoration: none;
  color: rgba(15, 37, 71, .95);
  opacity: .9;
}

/* Success state polish */
.success-note{
  margin-top: 10px;
  font-size: 13px;
  color: rgba(15, 23, 42, .60);
}

/* Mobile */
@media (max-width: 480px){
  body{ padding: 14px; }
  .flow-title{ font-size: 19px; }
  .card{ padding: 20px; }
}
  @media (min-width: 900px){
  .flow-head{ margin-top: 8px; }
  .card{ margin-top: 12px; }
} 
</style>
</head>
<body>

<div class="flow-wrap">

<div class="flow-top flow-top--service">
  <!-- Ù„ÙˆÚ¯ÙˆÛŒ Ø¯ÙØªØ± (Ù‡Ù…Ø§Ù† ÙØ§ÛŒÙ„ Ø±ÛŒÙ¾Ùˆ) -->
  <a class="brand" href="index.html" aria-label="Ù¾Ù„ÛŒØ³+Û±Û° Ø§ÙØ³Ø±ÛŒÙ‡">
    <img src="assets/img/logo/logo_white.png" class="brand__logo" alt="Ù¾Ù„ÛŒØ³+Û±Û° Ø§ÙØ³Ø±ÛŒÙ‡">
  </a>

  <!-- Ø¯Ú©Ù…Ù‡ Ø¯Ø±ÛŒØ§ÙØª ÙØ±Ù… Ú¯Ø°Ø±Ù†Ø§Ù…Ù‡ (Ù‡Ù…Ø§Ù† Ø§Ø³ØªØ§ÛŒÙ„/Ú©Ø§Ù†Ù¾ÙˆÙ†Ù†Øª ØµÙØ­Ù‡ Ø®Ø¯Ù…Øª) -->
  <a class="cta-service" href="assets/forms/passport.pdf" download>
    Ø¯Ø±ÛŒØ§ÙØª ÙØ±Ù… Ú¯Ø°Ø±Ù†Ø§Ù…Ù‡
  </a>
</div>

  <div class="flow-head">
    <div class="flow-kicker">ÙØ±Ù… Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ</div>
    <h1 class="flow-title">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ Ù…Ø±Ø­Ù„Ù‡â€ŒØ¨Ù‡â€ŒÙ…Ø±Ø­Ù„Ù‡ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</h1>
    <div class="flow-subtitle">Ø¯Ø± Ù¾Ø§ÛŒØ§Ù†ØŒ ÙØ§ÛŒÙ„ PDF Ø¢Ù…Ø§Ø¯Ù‡ Ú†Ø§Ù¾ Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯.</div>
  </div>

  <div class="card">
    <div class="progress" id="progress"></div>
    <h3 id="question"></h3>

    <input
      type="text"
      id="answerInput"
      inputmode="text"
      autocomplete="off"
      autocorrect="on"
      autocapitalize="none"
      spellcheck="true"
    />

    <div class="ios-hint" id="iosHint">
      Ø¯Ø± Ø¢ÛŒÙÙˆÙ†ØŒ Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ ØµÙˆØªÛŒ Ø§Ø² Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ†Ù Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.
    </div>

    <button class="voice" id="voiceButton">ğŸ¤ ÙˆØ±ÙˆØ¯ ØµÙˆØªÛŒ</button>
    <button class="primary" id="nextButton">Ø¨Ø¹Ø¯ÛŒ</button>

    <button class="primary" id="downloadPdfButton" style="display:none;">Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF</button>

    <div class="bottom-row">
      <a href="passport.html">Ø®Ø±ÙˆØ¬</a>
      <a href="#" onclick="location.reload(); return false;">Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯</a>
    </div>

    <div class="success-note" id="wmNote" style="display:none;">
      ÙØ§ÛŒÙ„ Ø®Ø±ÙˆØ¬ÛŒ Ø´Ø§Ù…Ù„ ÙˆØ§ØªØ±Ù…Ø§Ø±Ú© Ø¯ÙØªØ± Ø§Ø³Øª.
    </div>
  </div>

</div>
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {

  const questions = [
    { question: "Ù†Ø§Ù… Ø´Ù…Ø§ Ú†ÛŒØ³ØªØŸ", key: "firstName" },
    { question: "Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø´Ù…Ø§ Ú†ÛŒØ³ØªØŸ", key: "lastName" },
    { question: "Ù‚Ø¯ Ø´Ù…Ø§ Ú†Ù‚Ø¯Ø± Ø§Ø³ØªØŸ", key: "height" }
  ];

  let currentStep = 0;
  const answers = {};

  const questionEl = document.getElementById("question");
  const inputEl = document.getElementById("answerInput");
  const nextBtn = document.getElementById("nextButton");
  const progressEl = document.getElementById("progress");
  const voiceBtn = document.getElementById("voiceButton");
  const downloadBtn = document.getElementById("downloadPdfButton");
  const iosHint = document.getElementById("iosHint");

  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  if (isIOS) {
    voiceBtn.style.display = "none";
    iosHint.style.display = "block";
  }

  function normalizePersianNumbers(text) {
    return String(text || "")
      .replace(/[Û°-Û¹]/g, d => "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹".indexOf(d))
      .replace(/[Ù -Ù©]/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d));
  }

  // ====== PNG TEXT RENDER ======
  async function drawTextAsPngOnPdf(pdfDoc, page, text, x, y, fontSize) {
    const t = String(text ?? "").trim();
    if (!t) return;

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    const pad = Math.ceil(fontSize * 0.6);

    ctx.font = `${fontSize}px Vazirmatn`;
    ctx.direction = "rtl";
    ctx.textAlign = "right";
    ctx.textBaseline = "alphabetic";

    const m = ctx.measureText(t);
    const w = Math.ceil(m.width) + pad * 2;
    const h = Math.ceil(fontSize * 1.6) + pad * 2;

    canvas.width = w;
    canvas.height = h;

    ctx.font = `${fontSize}px Vazirmatn`;
    ctx.direction = "rtl";
    ctx.textAlign = "right";
    ctx.textBaseline = "alphabetic";

    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = "#000";
    ctx.fillText(t, w - pad, h - pad);

    const dataUrl = canvas.toDataURL("image/png");
    const pngBytes = await fetch(dataUrl).then(r => r.arrayBuffer());
    const png = await pdfDoc.embedPng(pngBytes);

    const SCALE = 0.75;
    const imgW = w * SCALE;
    const imgH = h * SCALE;

    page.drawImage(png, {
      x: x - imgW + 1,
      y: y - (fontSize * SCALE),
      width: imgW,
      height: imgH,
    });
  }
  // ====== END PNG TEXT RENDER ======

  function showQuestion() {
    if (currentStep < questions.length) {
      questionEl.innerText = questions[currentStep].question;
      progressEl.innerText = "Ø³Ø¤Ø§Ù„ " + (currentStep + 1) + " Ø§Ø² " + questions.length;
      inputEl.value = "";

      if (questions[currentStep].key === "height") {
        inputEl.type = "text";
        inputEl.inputMode = "decimal";
        inputEl.dir = "ltr";
      } else {
        inputEl.type = "text";
        inputEl.inputMode = "text";
        inputEl.dir = "rtl";
      }

      inputEl.focus();
    } else {
      questionEl.innerText = "ØªÙ…Ø§Ù… Ø´Ø¯ âœ…";
      progressEl.innerText = "";
      inputEl.style.display = "none";
      nextBtn.style.display = "none";
      voiceBtn.style.display = "none";
      downloadBtn.style.display = "block";
      document.getElementById("wmNote").style.display = "block";
    }
  }

  nextBtn.addEventListener("click", function () {
    const raw = inputEl.value.trim();
    if (!raw) return;
    answers[questions[currentStep].key] = normalizePersianNumbers(raw);
    currentStep++;
    showQuestion();
  });

  // Voice Input (Android/Windows)
  voiceBtn.addEventListener("click", function () {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("Ø§ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø² ÙˆØ±ÙˆØ¯ÛŒ ØµÙˆØªÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.");
      return;
    }

    const recognition = new SpeechRecognition();
    recognition.lang = "fa-IR";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    voiceBtn.disabled = true;
    voiceBtn.textContent = "ğŸ™ï¸ Ø¯Ø± Ø­Ø§Ù„ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù†...";

    recognition.onresult = function (event) {
      const text = event.results?.[0]?.[0]?.transcript || "";
      inputEl.value = normalizePersianNumbers(text);
    };

    recognition.onerror = function (event) {
      alert("Ø®Ø·Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ ØµÙˆØªÛŒ: " + (event.error || "Ù†Ø§Ù…Ø´Ø®Øµ"));
    };

    recognition.onend = function () {
      voiceBtn.disabled = false;
      voiceBtn.textContent = "ğŸ¤ ÙˆØ±ÙˆØ¯ ØµÙˆØªÛŒ";
    };

    recognition.start();
  });

  downloadBtn.addEventListener("click", async function () {
    try {
      await generatePdf(answers);
    } catch (e) {
      console.error(e);
      alert("Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª PDF");
    }
  });

  async function generatePdf(answers) {
    const { PDFDocument } = PDFLib;

    const templateUrl = "assets/forms/passport.pdf";
    const existingPdfBytes = await fetch(templateUrl).then(r => r.arrayBuffer());
    const pdfDoc = await PDFDocument.load(existingPdfBytes);
    const page0 = pdfDoc.getPages()[0];

    await drawTextAsPngOnPdf(pdfDoc, page0, answers.firstName, 451.25, 652.5, 11);
    await drawTextAsPngOnPdf(pdfDoc, page0, answers.lastName,  372.5,  615.63, 11);
    await drawTextAsPngOnPdf(pdfDoc, page0, answers.height,    326.88, 513.13, 11);

    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "passport-filled.pdf";
    a.click();
    URL.revokeObjectURL(url);
  }

  showQuestion();
});
</script>

</body>
</html>
